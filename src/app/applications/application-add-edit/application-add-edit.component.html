<div class="application-edit">
  <div class="container" *ngIf="application">
    <div class="title-container mb-4">
      <h1 class="title-container__title">Edit Application</h1>
      <div class="pg-title-container__actions">
        <a class="btn btn-light slide-l-btn" [routerLink]="['/a', application._id]">
          <i class="material-icons">info_outline</i>
          <span>Application Details</span>
        </a>
      </div>
    </div>

  <div class="row">
    <main class="col-lg-8">
      <form #applicationForm="ngForm">
        
          <!-- HEADER -->
          <section class="card bg-dark">
            <span class="d-flex justify-content-between">
                <h2 class="mb-0">{{application.client || '-'}}</h2>
              <button type="button" class="btn btn-primary float-right" (click)="selectClient()">
                <i class="material-icons">contacts</i>
                <span>Select Client</span>
              </button>
            </span>

            <div>{{application.purpose || '-'}} &nbsp; / &nbsp; {{application.subpurpose || '-'}}</div>
            <!--
            <h3>{{applicationService.getStatus(application) || '-'}}</h3>
            -->
            <ul class="application-edit__list">
              <li>CL File(s): {{application.cl_files ? application.cl_files.join(', ') : '-'}}</li>
              <li *ngIf="application.features?.length > 0">Disp ID: {{application.features[0].properties.DISPOSITION_TRANSACTION_SID}}</li>
            </ul>
          </section>

          <!-- DISPOSITION -->
          <section class="card bg-light">
            <h3>Disposition</h3>

            <div class="form-group mb-0 required">
              <h4 for="tantalisID" class="control-label mb-0">Disposition ID</h4>
              <input type="number" class="form-control" id="tantalisID" name="tantalisID" required area-required="true" [(ngModel)]="application.tantalisID"
                #tantalisID="ngModel" (keyup.enter)="applyDisposition()">
              <button type="button" class="btn btn-primary float-left" (click)="applyDisposition()">
                <i class="material-icons">system_update_alt</i>
                <span>Fetch Disposition Data</span>
              </button>
              <div [hidden]="tantalisID.valid || tantalisID.untouched" class="alert alert-danger">Disposition ID is required</div>
            </div>
          </section>

          <!-- BASIC INFORMATION -->
          <section class="card bg-light" *ngIf="application.features && application.features.length > 0">
            <h3>Basic Information</h3>

            <ul class="application-edit__list">
              <li class="pt-0">
                <span class="name">Type / Subtype</span>
                <span class="value">{{application.features[0].properties.TENURE_TYPE || '-'}} / {{application.features[0].properties.TENURE_SUBTYPE
                  || '-'}}</span>
              </li>
              <li class="pt-0">
                <span class="name">Status</span>
                <span class="value">{{application.features[0].properties.TENURE_STATUS || '-'}}</span>
              </li>
              <li>
                <span class="name">Stage</span>
                <span class="value">{{application.features[0].properties.TENURE_STAGE || '-'}}</span>
              </li>
              <li>
                <span class="name">Agency</span>
                <span class="value">{{application.agency || '-'}}</span>
              </li>
            </ul>
            <hr>
            <ul class="application-edit__list">
              <li class="pt-0">
                <span class="name">Business Unit</span>
                <span class="value">{{application.features[0].properties.RESPONSIBLE_BUSINESS_UNIT || '-'}}</span>
              </li>
              <li class="pt-0">
                <span class="name">Region</span>
                <span class="value">{{application.region || '-'}}</span>
              </li>
              <li>
                <span class="name">Location</span>
                <span class="value">{{application.features[0].properties.TENURE_LOCATION || '-'}}</span>
              </li>
              <li>
                <span class="name">Total Area (hectares)</span>
                <span class="value">{{application.areaHectares ? (application.areaHectares | number:'1.2-2') : '-'}}</span>
              </li>
            </ul>
          </section>

          <!-- APPLICATION -->
          <section class="card bg-light">
            <h3>Application</h3>

            <div class="form-group required">
              <h4 for="description" class="control-label mb-0">Description</h4>
              <textarea type="text" class="form-control" id="description" name="description" rows="5" required area-required="true" [(ngModel)]="application.description"
                #description="ngModel"></textarea>
              <div [hidden]="description.valid || description.untouched" class="alert alert-danger">Description is required</div>
            </div>

            <h4 class="mb-0">Application Documents</h4>
            <div *ngIf="!application.documents || application.documents.length === 0">
              <em>This application has no documents.</em>
            </div>

            <ul class="document-list list-group">
              <li class="list-group-item" *ngFor="let file of application.documents">
                <span class="cell icon pr-0">
                  <i class="material-icons">attachment</i>
                </span>
                <span class="cell name" [title]="file.displayName || ''">{{file.documentFileName}}</span>
                <span class="cell actions">
                  <button type="button" class="btn btn-primary" (click)="api.downloadDocument(file)" title="Download this document">
                    <i class="material-icons">file_download</i>
                  </button>
                  <button type="button" class="btn btn-primary" (click)="api.openDocument(file)" title="Open this document">
                    <i class="material-icons">open_in_new</i>
                  </button>
                  <button type="button" *ngIf="!file.isPublished" class="btn btn-danger" (click)="deleteDocument(file, application.documents)"
                    title="Delete this document">
                    <i class="material-icons">delete</i>
                  </button>
                  <button type="button" *ngIf="!file.isPublished" class="btn btn-success" (click)="publishDocument(file, application.documents)"
                    title="Publish this document">
                    <i class="material-icons">play_arrow</i>
                  </button>
                  <button type="button" *ngIf="file.isPublished" class="btn btn-dark" (click)="unPublishDocument(file, application.documents)"
                    title="Un-publish this document">
                    <i class="material-icons">pause</i>
                  </button>
                </span>
              </li>
            </ul>

            <span>
              <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput1').click()">
                <i class="material-icons">file_upload</i>
                <span>Upload Files</span>
              </button>
              <input type="file" id="fileInput1" style="display: none;" (change)="uploadFiles($event.target.files, application.documents)"
                multiple />
            </span>

            <h4 class="mt-3 mb-0">Internal Notes</h4>
            <div class="form-group mb-0">
              <textarea type="text" class="form-control" id="internal.notes" name="internal.notes" rows="5" [(ngModel)]="application.internal.notes"></textarea>
            </div>
          </section>
        </form>

        <form #decisionForm="ngForm" style="margin-top: 2rem;">
          <!-- DECISION -->
          <section class="card bg-light">
            <h3>Decision</h3>

            <div *ngIf="!application.decision">
              <button type="button" class="btn btn-success" (click)="addDecision()" title="Add decision">
                <i class="material-icons">add</i>
                <span>Add Decision</span>
              </button>
            </div>

            <div *ngIf="application.decision">
              <div class="form-group required">
                <h4 for="decisionDesc" class="control-label mb-0">Description</h4>
                <textarea type="text" class="form-control" id="decisionDesc" name="decisionDesc" rows="5" [(ngModel)]="application.decision.description"
                  required area-required="true" #decisionDesc="ngModel"></textarea>
                <div [hidden]="decisionDesc.valid || decisionDesc.untouched" class="alert alert-danger">Decision Description is required</div>
              </div>

              <h4 class="mb-0">Decision Documents</h4>
              <div *ngIf="!application.decision.documents || application.decision.documents.length === 0">
                <em>This decision has no documents.</em>
              </div>

              <ul class="document-list list-group">
                <li class="list-group-item" *ngFor="let file of application.decision.documents">
                  <span class="cell icon pr-0">
                    <i class="material-icons">attachment</i>
                  </span>
                  <span class="cell name" [title]="file.displayName || ''">{{file.documentFileName}}</span>
                  <span class="cell actions">
                    <button type="button" class="btn btn-primary p-1" (click)="api.downloadDocument(file)" title="Download this document">
                      <i class="material-icons">file_download</i>
                    </button>
                    <button type="button" class="btn btn-primary p-1" (click)="api.openDocument(file)" title="Open this document">
                      <i class="material-icons">open_in_new</i>
                    </button>
                    <button type="button" class="btn btn-danger p-1" *ngIf="!file.isPublished" (click)="deleteDocument(file, application.decision.documents)"
                      title="Delete this document">
                      <i class="material-icons">delete</i>
                    </button>
                    <button type="button" class="btn btn-success p-1" *ngIf="!file.isPublished" (click)="publishDocument(file, application.decision.documents)"
                      title="Publish this document">
                      <i class="material-icons">play_arrow</i>
                    </button>
                    <button type="button" class="btn btn-dark p-1" *ngIf="file.isPublished" (click)="unPublishDocument(file, application.decision.documents)"
                      title="Un-publish this document">
                      <i class="material-icons">pause</i>
                    </button>
                  </span>
                </li>
              </ul>

              <span>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput2').click()">
                  <i class="material-icons">file_upload</i>
                  <span>Upload Files</span>
                </button>
                <input type="file" id="fileInput2" style="display: none;" (change)="uploadFiles($event.target.files, application.decision.documents)"
                  multiple />
              </span>

              <hr>

              <div class="decision-buttons">
                <!-- to save, application form must be valid -->
                <button type="button" class="btn btn-primary" (click)="saveDecision()" [disabled]="!decisionForm.form.valid" title="Save decision">
                  <i class="material-icons">save</i>
                  <span>Save</span>
                </button>
                <!-- to publish, application form must be valid -->
                <button type="button" *ngIf="!application.decision.isPublished" class="btn btn-success" (click)="publishDecision(application.decision)"
                  [disabled]="!decisionForm.form.valid" title="Publish decision">
                  <i class="material-icons">play_arrow</i>
                  <span>Publish</span>
                </button>
                <button type="button" *ngIf="application.decision.isPublished" class="btn btn-dark" (click)="unPublishDecision(application.decision)"
                  title="Un-publish decision">
                  <i class="material-icons">pause</i>
                  <span>Un-Publish</span>
                </button>
                <!-- to delete, there must be no decision documents -->
                <button type="button" *ngIf="!application.decision.isPublished" class="btn btn-danger" (click)="deleteDecision(application.decision)"
                  [disabled]="application.decision.documents?.length > 0" title="Delete decision">
                  <i class="material-icons">delete</i>
                  <span>Delete</span>
                </button>
              </div>
            </div>
          </section>
        </form>

        <!-- GEOGRAPHIC SHAPE DATA -->
        <!-- <section class="geo-shape-data card bg-light">
            <div class="title-container">
              <h3 class="title-container__title mb-0">Geographic Shape Data</h3>
  
              <div class="title-container__actions">
                <button class="btn btn-white slide-r-btn" (click)="launchMap()">
                  <span>See on map</span>
                  <i class="material-icons">place</i>
                </button>
              </div>
            </div>
            <span *ngIf="application.features">This application has
              <strong>{{application.features.length}}</strong> shape {{application.features.length === 1 ? 'file' : 'files'}}.</span>
            <div class="geo-shape-data__list">
              <section class="pt-3" *ngFor="let shape of application.features">
                <h4 class="mb-3">Interest ID: {{shape.properties.INTRID_SID}}</h4>
                <ul class="application-detail__list">
                  <li class="pt-0">
                    <span class="name">Type/Subtype</span>
                    <span class="value">{{shape.properties.TENURE_TYPE}}/{{shape.properties.TENURE_SUBTYPE}}</span>
                  </li>
                  <li class="pt-0">
                    <span class="name">Area (ha)</span>
                    <span class="value">
                      {{shape.properties.TENURE_AREA_IN_HECTARES ? (shape.properties.TENURE_AREA_IN_HECTARES | number:'1.2-2') : '-'}}
                    </span>
                  </li>
                  <li class="full-width">
                    <span class="name">Legal Description</span>
                    <span class="value">{{shape.properties.TENURE_LEGAL_DESCRIPTION}}</span>
                  </li>
                </ul>
              </section>
            </div>
          </section> -->
  
        <hr>

        <div class="application-buttons">
          <!-- to save, application form must be valid -->
          <button type="button" class="btn btn-primary" (click)="saveApplication()" [disabled]="!applicationForm.form.valid" title="Save application">
            <i class="material-icons">save</i>
            <span>Save</span>
          </button>
          <!-- to publish, application form must be valid -->
          <button type="button" *ngIf="!application.isPublished" class="btn btn-success" (click)="publishApplication(application)"
            [disabled]="!applicationForm.form.valid" title="Publish application">
            <i class="material-icons">play_arrow</i>
            <span>Publish</span>
          </button>
          <button type="button" *ngIf="application.isPublished" class="btn btn-dark" (click)="unPublishApplication(application)" title="Un-publish application">
            <i class="material-icons">pause</i>
            <span>Un-Publish</span>
          </button>
          <!-- to delete, there must be no application documents -->
          <button type="button" *ngIf="!application.isPublished" class="btn btn-danger" (click)="deleteApplication(application)" [disabled]="application.documents?.length > 0"
            title="Delete application">
            <i class="material-icons">delete</i>
            <span>Delete</span>
          </button>
        </div>

        <div *ngIf="showMsg">
          <div *ngIf="error" class="alert alert-danger">{{status}}</div>
          <div *ngIf="!error" class="alert alert-success">{{status}}</div>
        </div>
      </main>

      <aside class="col-lg-4">
          <!-- MAP THUMBNAIL -->
          <section class="map-thumbnail card p-0">
            <div class="map-container">
              <div class="map" id="map"></div>
            </div>
          </section>
  
          <!-- COMMENTING INFO -->
          <section class="comment-status card bg-light">
            <h4 class="title mb-0">{{commentPeriodService.getStatus(application.currentPeriod)}}</h4>
            <div class="mt-1" *ngIf="commentPeriodService.getStatus(application.currentPeriod) === commentPeriodService.commentStatuses['OPEN']">
              <span>{{application.currentPeriod.startDate | date:'mediumDate'}} - {{application.currentPeriod.endDate | date:'mediumDate'}}</span>
              <span class="badge badge-dark">{{daysRemaining}}</span>
            </div>
            <div class="comment-status__actions mt-4">
              <a class="btn btn-light slide-r-btn" [routerLink]="['/periods', application._id]">
                <span>Click to Modify</span>
                <i class="material-icons">arrow_forward</i>
              </a>
            </div>
          </section>
  
          <!-- NEW COMMENTS INFO -->
          <section class="comment-count card bg-light">
            <h4 class="title mb-3">New Comments</h4>
            <span class="badge badge-dark">{{numComments}}</span>
            <div class="comment-status__actions mt-4">
              <a class="btn btn-light slide-r-btn" [routerLink]="['/comments', application._id]">
                <span>Click to Review</span> 
                <i class="material-icons">arrow_forward</i>
              </a>
            </div>
          </section>
        </aside>

      </div>
  </div>
</div>